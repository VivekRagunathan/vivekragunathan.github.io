<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="generator" content="Hugo 0.75.1" />

  <title>CComPtr Misconception !!! &middot; A Developer&#39;s Experience</title>

  <meta name="description" content="" />

  

<meta itemprop="name" content="CComPtr Misconception !!!">
<meta itemprop="description" content="This is about a killer bug identified by our chief software engineer in our software.">
<meta itemprop="datePublished" content="2009-04-08T00:15:00+00:00" />
<meta itemprop="dateModified" content="2009-04-08T00:15:00+00:00" />
<meta itemprop="wordCount" content="593">



<meta itemprop="keywords" content="" />


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CComPtr Misconception !!!"/>
<meta name="twitter:description" content="This is about a killer bug identified by our chief software engineer in our software."/>


<meta property="og:title" content="CComPtr Misconception !!!" />
<meta property="og:description" content="This is about a killer bug identified by our chief software engineer in our software." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/2009/04/08/ccomptr-misconception/" />
<meta property="article:published_time" content="2009-04-08T00:15:00+00:00" />
<meta property="article:modified_time" content="2009-04-08T00:15:00+00:00" />



  <link type="text/css"
        rel="stylesheet"
        href="/css/print.css"
        media="print">

  <link type="text/css"
        rel="stylesheet"
        href="/css/poole.css">

  <link type="text/css"
        rel="stylesheet"
        href="/css/hyde.css">

  


  <link type="text/css" rel="stylesheet" href="/css/custom.css">

  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css?family=Open+Sans:400,400i,700&display=swap">

  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css"
        integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk="
        crossorigin="anonymous" />

  <link rel="apple-touch-icon-precomposed"
        sizes="144x144"
        href="/apple-touch-icon-144-precomposed.png">

  <link rel="shortcut icon" href="/images/favicon.png">

  
  </head>
<body>
  <aside class="sidebar">
  <div class="container">
    <div class="sidebar-about">
      
        
        <div class="author-image">
          <a href="/">
            <img 
              src="/images/profile.png" 
              class="img-circle img-headshot center" 
              alt="Profile Picture">
          </a>
        </div>
        
      

      <h1>A Developer&#39;s Experience</h1>

      
      <p class="lead">The romantic image of an über-programmer is someone who fires up Emacs, types like a machine gun, and delivers a flawless final product from scratch. A more accurate image would be someone who stares quietly into space for a few minutes and then says Hmm. I think I’ve seen something like this before – John D. Cook</p>
      
    </div>

    <hr />

    <nav>
      <ul class="sidebar-nav">
        
        <li>
          <a href="/post/">Posts</a>
        </li><li>
          <a href="/pages">Pages</a>
        </li><li>
          <a href="/about/">About</a>
        </li><li>
          <a href="/quotations">Qs</a>
        </li>
      </ul>
    </nav>

    <section class="social-icons">
      
      <a href="#" rel="me" title="Linkedin" target="_blank">
        <i class="fab fa-linkedin" aria-hidden="true"></i>
      </a>
      
      <a href="#" rel="me" title="GitHub" target="_blank">
        <i class="fab fa-github" aria-hidden="true"></i>
      </a>
      
      <a href="#" rel="me" title="Twitter" target="_blank">
        <i class="fab fa-twitter" aria-hidden="true"></i>
      </a>
      
    </section>
  </div>
</aside>


  <main class="content container">
  <div class="post">
  <div class="image featured">
  	
	</div>

  <h1>CComPtr Misconception !!!</h1>


  <div class="post-date">
    <time datetime="2009-04-08T00:15:00Z">Apr 8, 2009</time> &middot; 3 min read
  </div>

  <p style="font-family:Tahoma;">
  This is about a killer bug identified by our chief software engineer in our software. What was devised for ease of use and write smart code ended up in this killer defect due to improper perception. Ok, let us go!
</p>
<p>CComPtr is a template class in ATL designed to wrap the discrete functionality of COM object management – <font face="Consolas">AddRef</font> and <font face="Consolas">Release</font>. Technically it is a smart pointer for a COM object.</p>
<pre style="font-family:Consolas;font-size:11pt;">void SomeMethod()<br />{<br />   CComPtr siPtr;<br />   HRESULT hr = siPtr.CoCreateInstance(CLSID_SomeComponent);<br />   siPtr-&gt;MethodOne(20, L"Hello");<br />}</pre>
<p style="font-family:Tahoma;">
  Without CComPtr, the code wouldn&#8217;t be as elegant as above. The code would be spilled with AddRef and Release. Besides, writing code to Release after use under any circumstance is either hard or ugly. CComPtr automatically takes care of releasing in its destructor just like std::auto_ptr. As a C++ programmer, we must be able to appreciate the inevitability of the destructor and its immense use in writing smart code. However there is a difference between pointers to normal C++ objects and pointers to COM objects; CComPtr and std::auto_ptr. When you assign one auto_ptr to another, the source is no more the owner of the object pointing to. The ownership is transferred to the destination. Whereas when a CComPtr is assigned to another, the reference count of the target COM object increases by one. And the two CComPtrs point to the same COM object. Changes made via one CComPtr object can be realized when the object is accessed via the other CComPtr. Release must be called on each CComPtr instance (to completely release the COM object). All fine, lets us see some code.
</p>
<pre style="font-family:Consolas;font-size:11pt;">void SomeOtherMethod()<br />{<br />   CComPtr aPtr;<br />   InitAndPopulateObject(aPtr);<br /><br />   int itemCount = 0;<br />   HRESULT hr = aPtr-&gt;GetCount(&itemCount);<br />   _ASSERTE(SUCCEEDED(hr));<br /><br />   for (int i = 0; i &lt; itemCount; ++i)<br />   {<br />      TCHAR szBuffer[128] = { 0 };<br />      sprintf_s(szBuffer, sizeof(szBuffer), "Key%ld", i);<br />      CComBSTR bstrKey(szBuffer);<br /><br />      int iValue = 0;<br />      hr = aPtr-&gt;GetItem(bstrKey, &iValue);<br />      _ASSERTE(SUCCEEDED(hr));<br /><br />      std::cout &lt;&lt; bstrKey &lt;&lt; " - " &lt;&lt; iValue;<br />   }<br />}<br /><br />void InitAndPopulateObject(CComPtr bPtr)<br />{<br />   HRESULT hr = ptr.CoCreateInstance(CLSID_Hashtable);<br />   <br />   _ASSERTE(SUCCEEDED(hr));<br /><br />   for (int i = 0; i &lt; 100; ++i)<br />   {<br />      TCHAR szBuffer[128] = { 0 };<br />      sprintf_s(szBuffer, sizeof(szBuffer), "Key%ld", i);<br />      bPtr-&gt;Add(szBuffer, i);<br />   }  <br />}</pre>
<p style="font-family:Tahoma;">
  CComPtr saved a whole of code as explained above. But my application was always crashing in the <font face="Consolas">SomeOtherMethod</font> on the line where <font face="Consolas">GetCount</font> method is called on the COM object initialized one line above. So I am passing a CComPtr to <font face="Consolas">InitAndPopulateObject</font>, which is supposed to create me my COM object and fill it with some information I expect. Since I am passing a CComPtr, a return value is not needed. Looks fine, but the application crashed.
</p>
<p>People are often misled with many things in programming mostly because they stick to the prime way of its use. CComPtr, in most cases, is used for creating a COM object, passed around across various sections in the code where <font face="Consolas">AddRef</font> and <font face="Consolas">Release</font> is done under the covers until the COM object dies a pleasant death. People tend to forget that the member in CComPtr (named poorly as p) is the one that is actually pointing to the COM object. So <font face="Consolas">aPtr.p</font>, whose value is 0x0000 (NULL), is passed by value and copied to bPtr.p. When the COM object is created using bPtr, it is <font face="Consolas">bPtr.p</font> ,which is assigned the COM object’s address, say 0x23456789; whereas <font face="Consolas">aPtr.p</font> remains <font face="Consolas">NULL</font> even after <font face="Consolas">InitAndPopulateObject</font> returns. Hence the application was crashing because of null pointer access.</p>
<p>The problem might be obvious in the above few lines of clear code. It sure was very tough to locate and reason it in our huge code base.</p>

</div>


  </main>

  <footer>
  <div>
    &copy;  2020

    &middot; <a href="https://creativecommons.org/licenses/by-sa/4.0" target="_blank">CC BY-SA 4.0</a>

    
  </div>
</footer>


  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"
          integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0="
          crossorigin="anonymous"></script>

  

  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/ocean.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/scala.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>


  

  
</body>
</html>
